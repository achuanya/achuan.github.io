---
comments: true
layout: post
title: Docker笔记
description: Docker笔记
category: 技术
---

## Docker

### 安装
```bash
$ sudo pacman -S docker
# 设置Docker开机启动服务
$ sudo systemctl enable docker

```

### 配置

```bash
# 更换为阿里云镜像并写入一下配置
https://cr.console.aliyun.com/cn-hangzhou/instances/repositories
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": ["https://XXXX.mirror.aliyuncs.com"]
}
EOF

# 重载配置文件
$ sudo systemctl daemon-reload
$ sudo systemctl restart docker
# 添加一个Docker组
$ sudo groupadd docker
# 将登录用户加入到Docker用户组中
$ sudo gpasswd -a ${USER} docker
# 更新用户组
$ newgrp docker
```

### 安装Centos

```bash
# 拉取centos6
$ docker pull centos6
$ docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
debian              latest              3de0e2c97e5c        7 days ago          114MB
# 创建一个centos容器，并运行它将docker中的22和88端口映射到宿主机的22和80。
$ docker run -itd -p 22:22 -p 80:80 --name centos centos:6 bash
# 进入centos容器
$ docker exec -it centos bash

# 安装基础软件
$ yum -y install vim git wget unzip

# 备份源
$ cd /etc/yum.repos.d/
$ mv CentOS-Base.repo CentOS-Base.repo.backup
#  更换源为阿里源
$ wget -O CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo

# 更新源
$ yum -y update
```



```bash
# 列出所有镜像详情信息
$ docker images
# 删除镜像
$ docker rmi [REPOSITORY:TAG] OR [IMAGE ID]
# 列出所有容器详情信息 -aq：列出所有容器CONTAINER ID
$ docker ps -a

$ docker [] [CONTAINER ID] OR [NAMES]
- stop
- start
- kill
- restart

# 删除全部容器
$ docker rm $(docker ps -aq)
```

## apache

### 安装

```bash
$ docker pull httpd
```

### 通过 Dockerfile 构建

```bash
# 创建配置文件夹
$ mkdir -p ~/www ~/Config/httpd/conf ~/Config/httpd/logs

$ cd ~/Config/httpd/
$ vim Dockerfile
FROM debian:jessie

# add our user and group first to make sure their IDs get assigned consistently, regardless of whatever dependencies get added
#RUN groupadd -r www-data && useradd -r --create-home -g www-data www-data

ENV HTTPD_PREFIX /usr/local/apache2
ENV PATH $PATH:$HTTPD_PREFIX/bin
RUN mkdir -p "$HTTPD_PREFIX" \
    && chown www-data:www-data "$HTTPD_PREFIX"
WORKDIR $HTTPD_PREFIX

# install httpd runtime dependencies
# https://httpd.apache.org/docs/2.4/install.html#requirements
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        libapr1 \
        libaprutil1 \
        libaprutil1-ldap \
        libapr1-dev \
        libaprutil1-dev \
        libpcre++0 \
        libssl1.0.0 \
    && rm -r /var/lib/apt/lists/*

ENV HTTPD_VERSION 2.4.20
ENV HTTPD_BZ2_URL https://www.apache.org/dist/httpd/httpd-$HTTPD_VERSION.tar.bz2

RUN buildDeps=' \
        ca-certificates \
        curl \
        bzip2 \
        gcc \
        libpcre++-dev \
        libssl-dev \
        make \
    ' \
    set -x \
    && apt-get update \
    && apt-get install -y --no-install-recommends $buildDeps \
    && rm -r /var/lib/apt/lists/* \
    \
    && curl -fSL "$HTTPD_BZ2_URL" -o httpd.tar.bz2 \
    && curl -fSL "$HTTPD_BZ2_URL.asc" -o httpd.tar.bz2.asc \
# see https://httpd.apache.org/download.cgi#verify
    && export GNUPGHOME="$(mktemp -d)" \
    && gpg --keyserver ha.pool.sks-keyservers.net --recv-keys A93D62ECC3C8EA12DB220EC934EA76E6791485A8 \
    && gpg --batch --verify httpd.tar.bz2.asc httpd.tar.bz2 \
    && rm -r "$GNUPGHOME" httpd.tar.bz2.asc \
    \
    && mkdir -p src \
    && tar -xvf httpd.tar.bz2 -C src --strip-components=1 \
    && rm httpd.tar.bz2 \
    && cd src \
    \
    && ./configure \
        --prefix="$HTTPD_PREFIX" \
        --enable-mods-shared=reallyall \
    && make -j"$(nproc)" \
    && make install \
    \
    && cd .. \
    && rm -r src \
    \
    && sed -ri \
        -e 's!^(\s*CustomLog)\s+\S+!\1 /proc/self/fd/1!g' \
        -e 's!^(\s*ErrorLog)\s+\S+!\1 /proc/self/fd/2!g' \
        "$HTTPD_PREFIX/conf/httpd.conf" \
    \
    && apt-get purge -y --auto-remove $buildDeps

COPY httpd-foreground /usr/local/bin/

EXPOSE 80
CMD ["httpd-foreground"]

# 创建启动脚本
$ vim httpd-foreground
#!/bin/bash
set -e
# Apache gets grumpy about PID files pre-existing
rm -f /usr/local/apache2/logs/httpd.pid
exec httpd -DFOREGROUND

# 赋予httpd-foreground文件可执行权限
$ sudo chmod +x httpd-foreground
```








### 常用命令

#### 容器生命周期管理

```bash
# 创建一个新的容器并运行
run 
-a stdin：
-d：后台运行容器，并返回CONTAINER ID
-i：以交互式运行容器
-t：为容器重新分配一个伪收入终端
-p：指定端口映射，格式：宿主:容器
-m：设置容器使用内存的最大值
-v：绑定一个卷
--name：为容器指定一个NAME格式：--name centos7
--dns：指定容器使用的DNS服务器，默认和宿主一致

# 启动/停止/重启
start/stop/restart

# 杀掉一个运行中的容器
kill
-s：向容器发送一个信号

# 删除一个或多个容器
rm
-f：通过SIGKLL信号强制删除一个运行中的容器
-l：移除容器间的网络连接
-v：删除与容器关联的卷

# 暂停容器中所有的进程\恢复容器中所有的进程
pause\unpause

# 创建一个新的容器但不启动它
create

# 中以运行的容器中执行命令
exec
-d：分离模式，在后台运行
-i：即使没有附加也保持STDIN打开
-t：分配一个伪终端
```

#### 容器操作

```bash
#
ps

#
inspect

# 查看容器中运行的进程信息
top

#
events

```



#### 容器仓库

```bash

```



#### 本地镜像管理

```bash

```

```
:: apr-util可选依赖于mariadb-libs: enable mysql/mariadb support
:: python-pymysql可选依赖于mariadb: for using a local MariaDB instance
:: qt4可选依赖于mariadb-libs: MariaDB driver
:: qt5-base可选依赖于mariadb-libs: MariaDB driver

```

### 遇到的问题
#### docker start 无效

